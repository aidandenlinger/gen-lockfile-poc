name: Generate package-lock.json
on:
  workflow_dispatch:
  
permissions:
  # Needs to commit to this repo
  contents: write

jobs:
  generate-lockfile:
    if: github.ref_name != 'main'  # This should only be run on PRs

    name: Generate package-lock.json
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # 4.2.2
      
      - uses: actions/setup-node@1d0ff469b7ec7b3cb9d8673fde0c81c44821de2a # 4.2.0
        with:
          node-version: 22
          
      - name: Set git user to github-actions[bot]
        run: |
          git config --local user.name "github-actions[bot]"
          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
      - name: Generate package-lock.json
        run: npm i --package-lock-only

      - name: Check if package-lock.json changed at all
        id: package-lock-changed
        run: |
          ! git diff --exit-code -- package-lock.json || (echo "::error::package-lock.json had no updates! Aborting"; exit 1)

      # Use the REST API to commit changes, so we get automatic commit signing
      # https://gist.github.com/swinton/03e84635b45c78353b1f71e41007fc7c
      - name: Commit and push package-lock.json
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          FILE_TO_COMMIT: package-lock.json
          DESTINATION_BRANCH: ${{ github.ref_name }}
        run: |
          export TODAY=$( date -u '+%Y-%m-%d' )
          export MESSAGE="chore: regenerate package-lock.json ((Action #${{ github.run_id }})[${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}])"
          export SHA=$( git rev-parse $DESTINATION_BRANCH:$FILE_TO_COMMIT )
          export CONTENT=$( base64 -i $FILE_TO_COMMIT )
          gh api --method PUT /repos/:owner/:repo/contents/$FILE_TO_COMMIT \
            --field message="$MESSAGE" \
            --field content="$CONTENT" \
            --field encoding="base64" \
            --field branch="$DESTINATION_BRANCH" \
            --field sha="$SHA"
